steps:
  - checkout: self
    clean: true

  - task: xamops.azdevex.provisionator-task.provisionator@1
    displayName: 'Provisionator'
    condition: eq(variables['provisioning'], 'true')
    inputs:
      provisioning_script: $(provisionator.path)
      provisioning_extra_args: $(provisionator.extraArguments)

  - pwsh: |
      ./build.ps1 --target provision --TeamProject="$(System.TeamProject)"
    displayName: 'Cake Provision'
    condition: eq(variables['provisioningCake'], 'true')

  - task: UseDotNet@2
    displayName: 'Install .net core $(DOTNET_VERSION)'
    condition: ne(variables['DOTNET_VERSION'], '')
    inputs:
      version: $(DOTNET_VERSION)
      packageType: 'sdk'

  - pwsh: |
      ./build.ps1 -Script eng/devices/android.cake --project="$(devicetests.project)" --device=$(devicetests.device) --results="$(System.DefaultWorkingDirectory)/output/testlogs"
    displayName: $(Agent.JobName)

  - task: PublishTestResults@2
    displayName: Publish the $(System.StageName)_$(System.PhaseName)_$(System.JobName) test results
    condition: always()
    inputs:
      testResultsFormat: xUnit
      testResultsFiles: 'output/testlogs/**/TestResults.xml'
      testRunTitle: '$(System.StageName)_$(System.PhaseName)_$(System.JobName)'

  - task: PublishBuildArtifacts@1
    displayName: Publish the test logs
    condition: always()
    inputs:
      artifactName: $(System.StageName)_$(System.PhaseName)_$(System.JobName)
      pathToPublish: 'output/testlogs'
